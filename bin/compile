#!/bin/sh

#############################################################
## Provides a modular system for custom heroku deployments ##
##							   ##
## Author: Jorgen Evens <jorgen@evens.eu>                  ##
## License: New BSD License				   ##
#############################################################


BIN_DIR=$(dirname $0)

# Include helper
. "$BIN_DIR/helper.sh"

INSTALL="${BUILD_DIR}/build/heroku/install"
if [ -f "$INSTALL" ]; then
	INSTALL=`cat "$INSTALL"`
else
	INSTALL=""
fi

# Initial boot file
cat > "${BUILD_DIR}/boot.sh" << EOF
#!/bin/sh

EOF
chmod +x "${BUILD_DIR}/boot.sh"

# Mark a dependency as installed.
dependency_mark() {
        INSTALLED_DEPENDENCIES="$INSTALLED_DEPENDENCIES $1"
}

# Include a dependency because someone relies on this.
dependency_require() {
	package=$1
	# Test if it was included already
	echo " ${INSTALLED_DEPENDENCIES} " | grep -q "${package}"
	if [ $? -eq 0 ]; then
		return;
	fi

	if [ -f "${BUILD_DIR}/build/heroku/installers/${package}.sh" ]; then
		. "${BUILD_DIR}/build/heroku/installers/${package}.sh"
		dependency_mark "${package}"
		return;
	fi

	if [ -f "${BIN_DIR}/../installers/${package}.sh" ]; then
		. "${BIN_DIR}/../installers/${package}.sh"
		dependency_mark "${package}"
		return
	fi

	print_action "Installer for ${package} not found!"
	exit 1
}

if [ -f "${BUILD_DIR}/build/heroku/compile" ]; then
	. "${BUILD_DIR}/build/heroku/compile"
fi

# Install all packages contained within $INSTALL
for package in $INSTALL; do
	dependency_require "${package}"
done
